<script src="../director/build/director.js"></script>
<link rel="import" href="g-app-route.html">

<polymer-element name="g-app-router" attributes="autoInit defaultRoute">
	<template>
		<content select="[selector]"></content>
	</template>
	<script>
		(function(){

			var _this     = null;
			var _router   = null;
			var _selector = null;
			var _route    = null;
			var _selected = null;

			var _onRouteNotFound = function() {
				console.log('[ROUTER] Route Not Found');
				_router.setRoute(_this.defaultRoute);
			};

			var _loaderFor = function(route) {
				return function() {
					//console.log('[ROUTER] Loading path:', route.path, ', name:', route.name, ', args:', arguments);
					if(_selector.selected == route.name)
					{
						_bindValuesToSelectedElement();
					}
					else
					{
						_selector.selected = route.name;
						_route = route;
					}
				};
			};

			_bindValuesToSelectedElement = function() {
				//console.log('[ROUTER] Binding data to:', _selected);
				if(_route)
				{
					var map = _route.parse(window.location.hash);
					for (var key in map)
					{
						_selected[key] = map[key];								
					}
					if(_selected.on)
					{
						_selected.on();					
					}
				}

			};
			
			Polymer({
				autoInit: true,

				defaultRoute: null,
				
				domReady: function() {
					console.log('[ROUTER] domReady');
					_this = this;
					_selector = document.querySelector('[selector]');
					_selector.addEventListener('core-select', function(evt){
						if(evt.detail.isSelected)
						{
							_selected = evt.detail.item;
							_bindValuesToSelectedElement();
						}
					});

					var routes = document.querySelectorAll('g-app-route');
					if(!routes)
					{
						console.warn('No routes! Please add at least one <g-app-route> to <g-app-router>');
						return;
					}

					var map = {};
					var len = routes.length;
					for(var i = 0 ; i < len ; i++)
					{
						var route = routes[i];
						if(route.path)
						{
							//console.log('[ROUTER] Added', route.path);
							map[route.path] = _loaderFor(route);
						}
						else
						{
							throw 'All routes require a path';
						}
					}

					_router = new Router(map).configure({strict: false, notfound: _onRouteNotFound});
					if(this.autoInit)
					{
						this.init();
					}
				},

				init: function() {
					_router.init();
				},
			});
		}());
	</script>
</polymer-element>
